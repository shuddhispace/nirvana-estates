<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Buyers - Nirvana Estates</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body { background-color: #f9fafb; }

.card { transition: transform .3s, box-shadow .3s; }
.card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,.15); }

.carousel { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; gap: 0.75rem; padding: 0.5rem 0; -webkit-overflow-scrolling: touch; cursor: grab; scroll-behavior: smooth; }
.carousel:active { cursor: grabbing; }
.carousel::-webkit-scrollbar { display: none; }
.carousel-item { flex: 0 0 100%; scroll-snap-align: start; display: flex; justify-content: center; align-items: center; }

.media-wrapper {
  width: 100%;
  height: 500px;
  display: flex;
  justify-content: center;
  align-items: center;
  overflow: hidden;
}

.short-media {
  max-width: 100%;
  max-height: 100%;
  object-fit: contain;
  border-radius: 0.75rem;
  box-shadow: 0 6px 18px rgba(0,0,0,0.1);
  transition: transform .3s;
}
.short-media:hover { transform: scale(1.02); }

@media(min-width:1024px){
  #grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 1.5rem; }
  .media-wrapper { height: 350px; }
  .card-body { display: flex; flex-direction: column; gap:0.5rem; }
}

.card-body h3 { font-weight: 600; font-size: 1.125rem; color: #0f2b3d; }
.card-body span { font-weight: 700; color: #0f2b3d; }
.card-body p { font-size: 0.875rem; color: #555; }
.card-body ul { list-style: disc; padding-left: 1.25rem; color: #555; }

.modal img {
  width: auto;
  height: auto;
  max-width: 90vw;
  max-height: 90vh;
  object-fit: contain;
}
</style>
</head>
<body class="text-gray-800">

<div id="header-placeholder"></div>
<script>
fetch('header_main.html')
.then(response => response.text())
.then(data => { document.getElementById('header-placeholder').innerHTML = data; })
.catch(err => console.error('Failed to load header:', err));
</script>

<main class="max-w-7xl mx-auto px-4 py-6">
  <h2 class="text-2xl md:text-3xl font-bold text-gray-900 mb-6">Properties for Buyers</h2>
  <div id="grid" class="grid grid-cols-1 sm:grid-cols-1 lg:grid-cols-3 gap-6"></div>
</main>

<a href="tel:+917039199717" class="fixed bottom-4 right-4 z-50 bg-[#0f2b3d] text-white px-4 py-3 rounded-full shadow-lg font-semibold">
  ðŸ“ž Call Now
</a>

<script>
const INR = n => Number(n).toLocaleString('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 0 });
const BACKEND = "https://nirvana-estates-backend.onrender.com";

function fixMediaUrl(src){
  if(!src) return '';
  if(src.startsWith('http')) return src;
  return `${BACKEND}/${src.replace(/^\/+/, '')}`;
}

function createMediaSlide(src,type){
  const div=document.createElement('div'); div.className='carousel-item';
  if(type==='image'){
    const wrapper = document.createElement('div'); wrapper.className = 'media-wrapper';
    const img = document.createElement('img'); img.src = fixMediaUrl(src); img.alt = 'Property Image'; img.loading = 'lazy'; img.className = 'short-media';
    wrapper.appendChild(img); div.appendChild(wrapper);
  } else {
    let videoId='';
    if(src.includes('shorts/')) videoId=src.split('shorts/')[1].split('?')[0];
    else if(src.includes('youtu.be/')) videoId=src.split('youtu.be/')[1].split('?')[0];
    else if(src.includes('watch?v=')) videoId=src.split('watch?v=')[1].split('&')[0];
    const iframe = document.createElement('iframe');
    iframe.src = `https://www.youtube-nocookie.com/embed/${videoId}?rel=0`;
    iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
    iframe.allowFullscreen = true;
    iframe.className = 'short-media';
    div.appendChild(iframe);
  }
  return div;
}

function renderDescription(desc) {
  if (!desc) return '';
  const lines = desc.split(/\r?\n/);
  let html = '';
  let inList = false;

  lines.forEach(line => {
    const trimmed = line.trim();
    if(trimmed === '') { if(inList){ html+='</ul>'; inList=false; } return; }
    const isBullet = /^[-*â€¢]\s+/.test(trimmed);
    if(isBullet){
      if(!inList){ html+='<ul class="list-disc pl-5 text-sm text-gray-700 space-y-1">'; inList=true; }
      html+=`<li>${trimmed.replace(/^[-*â€¢]\s+/,'')}</li>`;
    } else {
      if(inList){ html+='</ul>'; inList=false; }
      html+=`<p class="text-sm text-gray-700 mb-2">${trimmed}</p>`;
    }
  });
  if(inList) html+='</ul>';
  return html;
}

function propertyCard(p){
  const card = document.createElement('article'); card.className='card bg-white rounded-xl overflow-hidden shadow hover:shadow-lg flex flex-col';

  const carousel = document.createElement('div'); carousel.className='carousel';
  const media = [...(p.images||[]).map(i=>({src:i,type:'image'})), ...(p.videos||[]).map(v=>({src:v,type:'video'}))];
  if(media.length){ media.forEach(m=>carousel.appendChild(createMediaSlide(m.src,m.type))); }
  else { const placeholder = document.createElement('div'); placeholder.className='w-full h-48 flex items-center justify-center text-gray-400 bg-gray-200'; placeholder.textContent='No media available'; carousel.appendChild(placeholder); }
  card.appendChild(carousel);

  const body = document.createElement('div'); body.className='card-body p-4 flex flex-col gap-3';
  const title = document.createElement('h3'); title.textContent = p.title||'Property'; body.appendChild(title);

  if(p.price && Number(p.price) > 0){ const price = document.createElement('span'); price.textContent = INR(p.price); body.appendChild(price); }

  if(p.description) { const descDiv = document.createElement('div'); descDiv.innerHTML = renderDescription(p.description); body.appendChild(descDiv); }

  const detailsArr=[];
  if(p.bedrooms && Number(p.bedrooms)>0) detailsArr.push(`${p.bedrooms} Bed`);
  if(p.bathrooms && Number(p.bathrooms)>0) detailsArr.push(`${p.bathrooms} Bath`);
  if(p.carpetArea) detailsArr.push(`Carpet: ${p.carpetArea} sq ft`);
  if(p.builtupArea) detailsArr.push(`Built-up: ${p.builtupArea} sq ft`);
  if(p.location) detailsArr.push(p.location);
  if(detailsArr.length){ const sub = document.createElement('p'); sub.className='text-gray-600 text-sm'; sub.textContent=detailsArr.join(' | '); body.appendChild(sub); }

  const ctaRow = document.createElement('div'); ctaRow.className='mt-2 flex flex-wrap gap-2';
  const detailsBtn = document.createElement('a'); detailsBtn.href=`property-details.html?id=${p._id}`; detailsBtn.target='_blank'; detailsBtn.className='px-3 py-2 rounded bg-[#0f2b3d] text-white text-sm font-semibold hover:bg-[#15425c]'; detailsBtn.textContent='View Details';
  const callBtn = document.createElement('a'); callBtn.href='tel:+917039199717'; callBtn.className='px-3 py-2 rounded bg-green-600 text-white text-sm font-semibold hover:bg-green-700'; callBtn.textContent='Call';
  ctaRow.append(detailsBtn, callBtn); body.appendChild(ctaRow);

  card.appendChild(body); return card;
}

async function load(){
  try{
    const res = await fetch(`${BACKEND}/api/properties`);
    const list = await res.json();
    const grid = document.getElementById('grid'); grid.innerHTML='';
    list.filter(p=>(p.category||'').toLowerCase()==='buyers').forEach(p=>grid.appendChild(propertyCard(p)));
  }catch(e){ console.error(e); document.getElementById('grid').innerHTML='<div class="text-red-600">Failed to load properties.</div>'; }
}
load();
</script>

<div class="bg-[#0f2b3d] text-gray-300 text-center text-sm py-4">
  Â© <span id="year"></span> Nirvana Estates. All rights reserved.
</div>
<script>document.getElementById('year').textContent = new Date().getFullYear();</script>
</body>
</html>
